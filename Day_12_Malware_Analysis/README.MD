# Day_12 [Malware-Analysis] Forensic McBlue to the REVscue!

+ Deployable Website: No
+ Deployable Container: Yes

Description: The malicious document attached to the phishing email was confirmed to have been executed. Aside from the fact that rogue connections were observed, we know little about what it does. Our in-house expert Forensic McBlue confirmed that the malicious document spawned another suspicious binary. Pivoting from that, he dumped it from memory for this task to be further analysed via Malware Analysis.

> RDP:
   `10.10.223.61`
   `administrator`
   `letmein123!`

## LEARNING OBJECTIVES

+ Learn the fundamentals of analysing malware samples without relying on automated sandbox scanners.
+ Learn and understand typical malware behaviour and its importance in the incident investigation pipeline.

## NOTES

1. **Malware** is software created to harm a computer or an entire network.
2. Common Behaviours
   1. *Network connections* - Malware tends to establish either external network connections or internal connections. External connections allow remote access or for downloading staged payloads from a threat actors' infrastructure. Meanwhile, internal connections allow for lateral movement, a technique used to extend access to other hosts or applications within the network.
   2. *Registry key modifications* - Malware typically uses registry keys to establish persistence, a technique used by threat actors to discreetly maintain long-term access to a system despite disruptions. A good example is Registry Run Keys, which allows binaries to be automatically executed when a user logs in or the machine boots up.
   3. *File manipulations* -  Malware also tends to download (one of the common reasons to establish network connections) or create new files needed for its successful execution.
3. Tips for handling live malware
   1. Always assume that malware samples will infect your device; hence executing it is not always the first and only step in analysing it.
   2. Only run the malware sample in a controlled environment that prevents potential compromise of unwanted assets.
   3. It is always recommended to have your sandbox, which allows you have a worry-free execution of malware samples.
4. Static Analysis
   1. Static Analysis is a way of analysing a malware sample without executing the code. This method mainly focuses on profiling the binary with its readable information, such as its properties, program flow and strings. Given the limitation of not executing it, sometimes this method gives insufficient information, which is why we resort to Dynamic Analysis.
5. Dynamic Analysis
   1. Dynamic Analysis mainly focuses on understanding the malware by executing it in a safe environment, such as a Sandbox. By doing this, you will see the malware live in action, its exact behaviour, and how it infects the environment.

## STEPS

1. Start machine
2. Connect with RDP using Remmina

3. STATIC ANALYSIS
   1. Detect_It_Easy
      1. Rightclick the file & select detectit_easy
         1. In here we can see the binary's architecture, and the executable packer used
         2. We can also run strings which will display all printable strings in the file
   2. CAPA
      1. Open powershell and move to the malware directory
      2. Run CAPA
         1. > capa mysterygift
         2. From this we can see that the this malware is `packed`
      3. UNPACK
         1. From powershell run upx
         2. > upx -d mysterygift
            1. From this we see `Filesize:502169 <- 27737 Ration:45.35% Format:win64/pe Name:mysterygift`
         3. Delete the old .viv file and reanalyze
      4. Re-Run CAPA
         1. > capa mystergift > CAPA_Analysis
         2. Saved the outpus to CAPA_Analysis file
            1. In here we can see the MITRE ATT$CK Techniques, Compiler, and other info

4. DYNAMIC ANALYSIS
   1. Lets start our Process Monitor (ProcMon)
      1. Then specify to match these conditions: ProcessName - is - mystergift.exe
      2. Click ok to add our condition
   2. Rename our mysterygift so it is executable
      1. > mv mystergift mysterygift.exe
   3. Run our mysterygift.exe
   4. Analyze with ProcMon
      1. Click on the following filters
         1. Show Registry Activity
         2. Show File System Activity
         3. Show Network Activity
         4. Show Process and Thread Activity
         5. Show Profiling Events
      2. As mentioned in th enotes we know malware trys to modify registry keys, modify files, & connect to networks. Lets look into these

      3. MODIFY REGISTRY KEYS
         1. Select just the first filter
         2. Now in the `operations` column rightclick and EXCLUDE the following:
            1. RegOpenKey
            2. RegQueryValue
            3. RegQueryKey
            4. RegCloseKey
         3. After doing this we see only 1 key that has both `RegCreateKey` & `RegSetValue`
            1. The `HKCU\Software\Microsoft\Windows\CurrentVersion\Run` key was modified
            2. This is for persistence and known as **Registry Run Key Modification**
            3. If we examine the key we can see the data value:
               1. `C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\wishes.bat`

      4. MODIFY FILES
         1. Change the filter to show file system activity
         2. Same as before we will EXCLUDE the following:
            1. CreateFile
            2. CreateFileMapping
            3. QuerySecurityFile
            4. QueryNameInformationFile
            5. QueryBasicInformationFile
            6. CloseFile
            7. ReadFile
         3. After doing this we can see `WriteFiles`
            1. Under the C:\Users\Administrator directory we can see 2 folders were created `TEMP` & `STARTUP`
               1. Under these folders 2 files were created `test.jpg` & `wishes.bat`

      5. NETWORK CONNECTION
         1. Change filer to show network activity
         2. In here we see:
            1. `bestfestivalcompany.thm:49733 -> bestfestivalcompany.thm:http`
            2. `virustotal.com:49734 -> virustotal.com:http`
         3. Going back to strings from the malware sample lets try and piece together the full URL that the virus was downloaded from
            1. Search by string: `befestival`
               1. We get the following string `http://bestfestivalcompany.thm/favicon.ico`

## QUESTIONS

1. What is the architecture of the malware sample? (32-bit/64-bit)
   1. `64-bit`
2. What is the packer used in the malware sample? (format: lowercase)
   1. `upx`
3. What is the compiler used to build the malware sample? (format: lowercase)
   1. `nim`
4. How many MITRE ATT&CK techniques have been discovered attributed to the DISCOVERY tactic?
   1. `2`
5. What is the registry key abused by the malware?
   1. `HKCU\Software\Microsoft\Windows\CurrentVersion\Run`
6. What is the value written on the registry key based on the previous question?
   1. `C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\wishes.bat`
7. What are the names of two files created by the malware under the C:\Users\Administrator\ directory? (format: file1,file2 in alphabetical order)
   1. `test.jpg,wishes.bat`
8. What are the two domains wherein malware has initiated a network connection? (format: domain1,domain2 in alphabetical order)
   1. `bestfestivalcompany.thm,virustotal.com`
9. Going back to strings inside the malware sample, what is the complete URL used to download the file hosted in the first domain accessed by the malware?
   1. `http://bestfestivalcompany.thm/favicon.ico`
